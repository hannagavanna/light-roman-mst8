import requests
import json
import datetime
import os
from telegram import Bot

# –ü–æ–ª—É—á–∞–µ–º —Å–µ–∫—Ä–µ—Ç—ã
BOT_TOKEN = os.environ.get("BOT_TOKEN")
CHAT_ID = os.environ.get("CHAT_ID")
ADDRESS = os.environ.get("ADDRESS")

bot = Bot(token=BOT_TOKEN)

# –§–∞–π–ª –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
STATE_FILE = "state.json"

# –°—Å—ã–ª–∫–∞ –Ω–∞ –≥—Ä–∞—Ñ–∏–∫ –î–¢–ï–ö (–ø—Ä–∏–º–µ—Ä –¥–ª—è –ö–∏–µ–≤–∞)
URL = "https://www.dtek-kem.com.ua/RU/shutdowns"

def load_state():
    if os.path.exists(STATE_FILE):
        with open(STATE_FILE, "r") as f:
            return json.load(f)
    return {"status": None, "last_change": None}

def save_state(state):
    with open(STATE_FILE, "w") as f:
        json.dump(state, f)

def get_status():
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ —Å —Å–∞–π—Ç–∞
    resp = requests.get(URL)
    data = resp.json()  # –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON
    # –ù–∞—Ö–æ–¥–∏–º –≥—Ä–∞—Ñ–∏–∫ –¥–ª—è –Ω–∞—à–µ–≥–æ –∞–¥—Ä–µ—Å–∞
    for entry in data.get("data", []):
        if entry.get("address") == ADDRESS:
            return entry.get("status"), entry.get("next_change")  # "on"/"off", –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    return None, None

def format_message(status, last_change, next_change):
    now = datetime.datetime.now()
    if last_change:
        last_time = datetime.datetime.fromisoformat(last_change)
        duration = now - last_time
        hours = duration.seconds // 3600
        minutes = (duration.seconds % 3600) // 60
        duration_text = f"{hours} —á {minutes} –º"
    else:
        duration_text = "‚Äì"

    if status == "on":
        status_text = "üü¢ –°–≤–µ—Ç –≤–∫–ª—é—á–∏–ª–∏"
    elif status == "off":
        status_text = "üî¥ –°–≤–µ—Ç –æ—Ç–∫–ª—é—á–∏–ª–∏"
    else:
        status_text = "‚ùì –°—Ç–∞—Ç—É—Å –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω"

    next_text = f"‚è∞ –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–æ–µ —Å–ª–µ–¥—É—é—â–µ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: {next_change}" if next_change else ""

    return f"{status_text}\nüïí –ë—ã–ª–æ {duration_text}\nüìç {ADDRESS}\n{next_text}\n(–ø–æ –≥—Ä–∞—Ñ–∏–∫—É –î–¢–ï–ö)"

def main():
    state = load_state()
    status, next_change = get_status()
    if status is None:
        print("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å")
        return

    if status != state.get("status"):
        # –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è
        message = format_message(status, state.get("last_change"), next_change)
        bot.send_message(chat_id=CHAT_ID, text=message)
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        save_state({"status": status, "last_change": datetime.datetime.now().isoformat()})
    else:
        print("–°—Ç–∞—Ç—É—Å –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è")

if __name__ == "__main__":
    main()